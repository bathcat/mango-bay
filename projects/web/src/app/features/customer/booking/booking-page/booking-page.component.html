<div class="booking-container">
  <h1>Book Cargo Delivery</h1>
  
  <mat-stepper #stepper orientation="vertical" linear>
    <!-- Step 1: Delivery Details -->
    <mat-step [stepControl]="state.bookingForm" label="Delivery Details">
      <form [formGroup]="state.bookingForm">
        <div class="step-content">
          <div class="form-row">
            <div class="form-field">
              <mbc-site-picker
                placeholder="Select origin"
                (valueChange)="onOriginChange($event)"
              ></mbc-site-picker>
              @if (getFieldError('originId')) {
                <div class="error-message">{{ getFieldError('originId') }}</div>
              }
            </div>
            
            <div class="form-field">
              <mbc-site-picker
                placeholder="Select destination"
                (valueChange)="onDestinationChange($event)"
              ></mbc-site-picker>
              @if (getFieldError('destinationId')) {
                <div class="error-message">{{ getFieldError('destinationId') }}</div>
              }
              @if (hasSameOriginDestination()) {
                <div class="error-message">Origin and destination must be different</div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <mbc-pilot-picker
                placeholder="Select pilot"
                (valueChange)="onPilotChange($event)"
              ></mbc-pilot-picker>
              @if (getFieldError('pilotId')) {
                <div class="error-message">{{ getFieldError('pilotId') }}</div>
              }
            </div>
            
            <div class="form-field">
              <mat-form-field appearance="outline">
                <mat-label>Weight (kg)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="cargoWeightKg"
                  placeholder="Enter weight"
                  (blur)="onFieldTouched('cargoWeightKg')"
                />
              </mat-form-field>
              @if (getFieldError('cargoWeightKg')) {
                <div class="error-message">{{ getFieldError('cargoWeightKg') }}</div>
              }
            </div>

            <div class="form-field">
              <mat-form-field appearance="outline">
                <mat-label>Scheduled Date</mat-label>
                <input
                  matInput
                  [matDatepicker]="picker"
                  formControlName="scheduledFor"
                  readonly
                  (blur)="onFieldTouched('scheduledFor')"
                />
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker [startAt]="minDate" ></mat-datepicker>
              </mat-form-field>
              @if (getFieldError('scheduledFor')) {
                <div class="error-message">{{ getFieldError('scheduledFor') }}</div>
              }
              @if (hasInvalidDate()) {
                <div class="error-message">Scheduled date must be tomorrow or later</div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-field full-width">
              <mat-form-field appearance="outline">
                <mat-label>Cargo Description</mat-label>
                <textarea
                  matInput
                  formControlName="cargoDescription"
                  placeholder="Describe your cargo"
                  (blur)="onFieldTouched('cargoDescription')"
                ></textarea>
              </mat-form-field>
              @if (getFieldError('cargoDescription')) {
                <div class="error-message">{{ getFieldError('cargoDescription') }}</div>
              }
            </div>
          </div>
        </div>
      </form>
      
      <div class="step-actions">
        <button
          mat-raised-button
          color="primary"
          [disabled]="!canProceedToEstimate()"
          (click)="calculateCost(stepper)"
        >
          Calculate Cost
        </button>
      </div>
    </mat-step>

    <!-- Step 2: Cost Estimate & Payment -->
    <mat-step label="Cost Estimate & Payment">
      <div class="step-content">
        @if (state.costEstimate$ | async; as costEstimateState) {
          @switch (costEstimateState.status) {
            @case ('loading') {
              <div class="loading-container">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Calculating cost...</p>
              </div>
            }
            @case ('loaded') {
              <mat-card class="estimate-card">
                <mat-card-header>
                  <mat-card-title>Cost Estimate</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="cost-breakdown">
                    <div class="cost-item">
                      <span>Base Rate:</span>
                      <span>${{ costEstimateState.value.baseRate.toFixed(2) }}</span>
                    </div>
                    <div class="cost-item">
                      <span>Distance Cost:</span>
                      <span>${{ costEstimateState.value.distanceCost.toFixed(2) }}</span>
                    </div>
                    <div class="cost-item">
                      <span>Weight Cost:</span>
                      <span>${{ costEstimateState.value.weightCost.toFixed(2) }}</span>
                    </div>
                    @if (costEstimateState.value.rushFee > 0) {
                      <div class="cost-item">
                        <span>Rush Fee:</span>
                        <span>${{ costEstimateState.value.rushFee.toFixed(2) }}</span>
                      </div>
                    }
                    <mat-divider></mat-divider>
                    <div class="cost-item total">
                      <span>Total Cost:</span>
                      <span>${{ costEstimateState.value.totalCost.toFixed(2) }} USD</span>
                    </div>
                    <div class="cost-item">
                      <span>Distance:</span>
                      <span>{{ costEstimateState.value.distance.toFixed(2) }} leagues</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>

              <div class="payment-section">
                <h3>Payment Information</h3>
                <mbc-credit-card-info
                  (valueChange)="onCreditCardChange($event)"
                ></mbc-credit-card-info>
              </div>
            }
            @case ('error') {
              <div class="error-container">
                <p>Error calculating cost: {{ costEstimateState.error }}</p>
              </div>
            }
          }
        }
      </div>
      
      <div class="step-actions">
        <button
          mat-button
          (click)="goBack(stepper)"
        >
          Back
        </button>
        <button
          mat-raised-button
          color="primary"
          [disabled]="!(canProceedToBooking$ | async)"
          (click)="bookDelivery(stepper)"
        >
          Book Delivery
        </button>
      </div>
    </mat-step>

    <!-- Step 3: Confirmation -->
    <mat-step label="Confirmation">
      <div class="step-content">
        @if (state.completedDelivery$ | async; as deliveryState) {
          @switch (deliveryState.status) {
            @case ('loading') {
              <div class="loading-container">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Processing your booking...</p>
              </div>
            }
            @case ('loaded') {
              <mat-card class="confirmation-card">
                <mat-card-header>
                  <mat-card-title>Booking Confirmed!</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="delivery-details">
                    <div class="detail-item">
                      <strong>Delivery ID:</strong> {{ deliveryState.value.id }}
                    </div>
                    <div class="detail-item">
                      <strong>Status:</strong> {{ deliveryState.value.status }}
                    </div>
                    <div class="detail-item">
                      <strong>Scheduled Date:</strong> {{ deliveryState.value.scheduledFor | date:'shortDate' }}
                    </div>
                    <div class="detail-item">
                      <strong>Cargo:</strong> {{ deliveryState.value.cargoDescription }}
                    </div>
                    <div class="detail-item">
                      <strong>Weight:</strong> {{ deliveryState.value.cargoWeightKg }} kg
                    </div>
                    <div class="detail-item">
                      <strong>Created:</strong> {{ deliveryState.value.createdAt | date:'medium' }}
                    </div>
                  </div>
                  <div class="confirmation-actions">
                    <a mat-raised-button color="accent" [routerLink]="['/deliveries', deliveryState.value.id]">
                      View Delivery Details
                    </a>
                  </div>
                </mat-card-content>
              </mat-card>
            }
            @case ('error') {
              <div class="error-container">
                <p>Error booking delivery: {{ deliveryState.error }}</p>
              </div>
            }
          }
        }
      </div>
      
      <div class="step-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="bookAnother()"
        >
          Book Another
        </button>
      </div>
    </mat-step>
  </mat-stepper>
</div>

